#include"../include/PreCond.h"

/***************************************************************************
* DATA DE CRIACAO  : 30/09/2019                                           *
* DATA DE MODIFICAO: 01/10/2020                                           *
* ----------------------------------------------------------------------- *
* preMake: monta os precondicionadores                                    *
* ----------------------------------------------------------------------- *
* Parametros de entrada:                                                  *
* ----------------------------------------------------------------------- *
* a       - matriz de coefientes n x n                                    *
* preCond - tipo do precondicionador                                      *
*         0 - nenhum                                                      *
*         1 - Jacobi                                                      *
*         2 - DILU                                                        *
*         3 - ILU                                                         *
* neq     - numero de linhas e colunas                                    *
* ----------------------------------------------------------------------- *
* Parametros de saida:                                                    *
* ----------------------------------------------------------------------- *
* m    - retorna o inverso do coefiente da diagonal                       *
* ----------------------------------------------------------------------- *
* OBS:                                                                    *
* ----------------------------------------------------------------------- *
***************************************************************************/
double* preMake(double *a, int const nEq, char preC)
{
  int i;
  double *m = NULL;

/*... nenhum*/
  if(preC == NONE){
    m = (double *) malloc(sizeof(double)*nEq);
    ERRO_MALLOC(m, "m",__LINE__, __FILE__, __func__);
    for(i = 0; i < nEq; i++)
      m[i] = 1.e0;
  }
/*...................................................................*/

/*... diagonal*/
  else if(preC == DIAGONAL){
    m = (double *) malloc(sizeof(double)*nEq);
    ERRO_MALLOC(m, "m",__LINE__, __FILE__, __func__);
    for(i = 0; i < nEq; i++)
      m[i] = 1.e0/a[i*nEq + i];
  }
/*...................................................................*/

/*... DILU*/
  else if(preC == DILU){
    m = (double *) malloc(sizeof(double)*nEq);
    ERRO_MALLOC(m, "m",__LINE__, __FILE__, __func__);
    dilu(m, a, nEq);
  }
/*...................................................................*/

  return m;

}
/**************************************************************************/

/**************************************************************************
* DATA DE CRIACAO  : 30/09/2019                                           *
* DATA DE MODIFICAO: 01/10/2020                                           *
* ----------------------------------------------------------------------- *
* preMake: monta os precondicionadores                                    *
* ----------------------------------------------------------------------- *
* Parametros de entrada:                                                  *
* ----------------------------------------------------------------------- *
* m   -> precondicionador                                                 *
* a   -> matriz de coeficientes nxn                                       *
* r   -> matriz de coefientes n                                           *
* x   -> matriz de coefientes n                                           *
* nEq -> numero de linhas e colunas                                       *
* preC-> tipo do precondicionador                                         *
*         0 - nenhum                                                      *
*         1 - Jacobi                                                      *
*         2 - DILU                                                        *
*         3 - ILU                                                         *
* ----------------------------------------------------------------------- *
* Parametros de saida:                                                    *
* ----------------------------------------------------------------------- *
* x -> retorna a solucao                                                  *
* ----------------------------------------------------------------------- *
* OBS:                                                                    *
* ----------------------------------------------------------------------- *
***************************************************************************/
void preCondSolver(double *m     , double *a
                 , double *r    , double *x
                 , int const nEq, char preC)
{

  int i;

/*... nenhum*/
  if(preC == NONE){
    for(i = 0; i < nEq; i++)
      x[i] = r[i];
  }

/*... diagonal*/
  else if(preC == DIAGONAL){
    for(i = 0; i < nEq; i++)
      x[i] = r[i]*m[i];
  }

/*... diagonal*/
  else if(preC == DILU){
    fb_dilu(r, a, m, x, nEq);
  }


}
/**************************************************************************/

/**************************************************************************
* DATA DE CRIACAO  : 30/09/2019                                           *
* DATA DE MODIFICAO: 00/00/0000                                           *
* ----------------------------------------------------------------------- *
* preMake: monta os precondicionadores                                    *
* ----------------------------------------------------------------------- *
* Parametros de entrada:                                                  *
* ----------------------------------------------------------------------- *
* m   -> nao definido                                                     *
* a   -> matriz de coeficientes nxn                                       *
* nEq -> numero de linhas e colunas                                       *
* ----------------------------------------------------------------------- *
* Parametros de saida:                                                    *
* ----------------------------------------------------------------------- *
* n -> precondicionador                                                   *
* ----------------------------------------------------------------------- *
* OBS:                                                                    *
* ----------------------------------------------------------------------- *
***************************************************************************/
void dilu(double *m, double *a, int const nEq)
{

  int i, j;

/*...*/
  for(i = 0; i < nEq; i++)
    m[i] = MAT2D(i, i, a, nEq);
/*........................................................................*/

/*...*/
  for(i = 0; i < nEq; i++)
    for(j = i + 1; j < nEq; j++)
      m[j] -= MAT2D(j, i, a, nEq) * MAT2D(i, j, a, nEq) / m[i];
/*........................................................................*/

}
/**************************************************************************/

/**************************************************************************
* DATA DE CRIACAO  : 30/09/2019                                           *
* DATA DE MODIFICAO: 01/10/2020                                           *
* ----------------------------------------------------------------------- *
* fb_dilu: forward e backward substituicao                                *
* ----------------------------------------------------------------------- *
* Parametros de entrada:                                                  *
* ----------------------------------------------------------------------- *
* r   - vetor de indepemdente                                             *
* a   - matriz de coeficientes                                            *
* d   - diagonal modificada do precondicionador                           *
* x   - nao definido                                                      *
* nEq - numero de equacoes                                                *
* ----------------------------------------------------------------------- *
* Parametros de saida:                                                    *
* ----------------------------------------------------------------------- *
* x    - solucao                                                          *
* ----------------------------------------------------------------------- *
* OBS:                                                                    *
* ----------------------------------------------------------------------- *
***************************************************************************/
void fb_dilu(double *r, double *a, double *d, double *x, int const nEq)
{

  int i, j;

/*...*/
  for(i = 0; i < nEq; i++){
    x[i] = r[i] / d[i];
    for(j = 0; j < i; j++)
      x[i] -=  MAT2D(i, j, a, nEq) * x[j] / d[i];
  }
/*........................................................................*/

/*...*/
  for(i = nEq - 1; i > -1; i--)
    for(j = i + 1; j < nEq; j++)
      x[i] -=  MAT2D(i, j, a, nEq) * x[j] / d[i];
/*........................................................................*/

}
/**************************************************************************/




